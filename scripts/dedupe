#!/usr/bin/env python

import argparse
from re import compile

TITLE_REGEX = compile("\s+<title>(.*)<\/title>$")
END_REGEX = compile("\s+<\/page>$")
TITLES = set()


def main():
    """Run the main program"""

    desc = """\
Remove duplicate titles from a wikimedia dump.

This script will scan through a wikimeda dump. If a duplicate title is found,
then it will be renamed with an appended "(dupe)" string added to the end.

Beware that it creates a new file the same size as the original. Make sure you
have enough space on your system for it."""

    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument(
        "input", metavar="<intput file>", help="the input file to parse"
    )
    parser.add_argument(
        "output", metavar="<input file>", help="the deduplicated output file to create"
    )

    # Signal whether the title should be skipped
    skip = False
    args = parser.parse_args()
    output = open(args.output, "w")
    with open(args.input) as _file:
        for line in _file:
            if skip:
                if END_REGEX.match(line):
                    skip = False
                continue
            match = TITLE_REGEX.match(line)
            if match:
                title = match.group(1)
                if title in TITLES:
                    print("Duplicate title: " + title)
                    skip = True
                    continue
                TITLES.add(title)
            output.write(line)


main()
